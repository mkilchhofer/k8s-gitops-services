apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: promtail
  namespace: argocd
spec:
  destination:
    namespace: logging
    server: https://kubernetes.default.svc
  project: core-services-unrestricted
  syncPolicy: {}
  source:
    chart: promtail
    repoURL: https://grafana.github.io/helm-charts/
    targetRevision: 4.2.0
    helm:
      version: v3
      valueFiles:
        - secrets+gpg-import-kubernetes://argocd/gpg-private-keys#app.asc?https://raw.githubusercontent.com/mkilchhofer/k8s-gitops-services/main/secrets/promtail.yaml
      values: |-
        defaultVolumes:
        - name: pods
          hostPath:
            path: /var/log/pods
        extraVolumes:
        - name: varlibpromtail
          hostPath:
            path: /var/lib/promtail

        defaultVolumeMounts:
        - name: pods
          mountPath: /var/log/pods
          readOnly: true
        extraVolumeMounts:
        - name: varlibpromtail
          mountPath: /var/lib/promtail

        config:
          file: |
            server:
              log_level: {{ .Values.config.logLevel }}
              http_listen_port: {{ .Values.config.serverPort }}

            clients:
              - url: {{ tpl .Values.config.lokiAddress . }}
              {{- with .Values.config.snippets.extraClientConfigs }}
              {{- toYaml . | nindent 2 }}
              {{- end }}

            positions:
              filename: /var/lib/promtail/positions.yaml

            scrape_configs:
              {{- tpl .Values.config.snippets.scrapeConfigs . | nindent 2 }}
              {{- tpl .Values.config.snippets.extraScrapeConfigs . | nindent 2 }}

        serviceMonitor:
          enabled: true

        extraObjects:
        - apiVersion: cilium.io/v2
          kind: CiliumNetworkPolicy
          metadata:
            name: promtail
          spec:
            endpointSelector:
              matchLabels:
                app.kubernetes.io/instance: promtail
                app.kubernetes.io/name: promtail
            egress:
              - toFQDNs:
                  - matchName: logs-prod-eu-west-0.grafana.net
                toPorts:
                  - ports:
                      - port: "443"
