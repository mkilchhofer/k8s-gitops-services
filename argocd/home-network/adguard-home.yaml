---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: adguard
  namespace: argocd
spec:
  destination:
    namespace: home-network
    server: https://kubernetes.default.svc
  project: default
  syncPolicy: {}
  source:
    chart: adguard-home
    repoURL: https://k8s-at-home.com/charts/
    targetRevision: "2.0.0"
    helm:
      releaseName: adguard
      values: |-
        image:
          repository: kicm/adguardhome
          tag: v0.103.3

        podSecurityContext:
          fsGroup: 2001

        securityContext:
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 2000

        ingress:
          enabled: true
          annotations:
            kubernetes.io/ingress.class: contour
            ingress.kubernetes.io/force-ssl-redirect: "true"
            cert-manager.io/cluster-issuer: letsencrypt
          path: /
          hosts:
            - adguard.tools.kilchhofer.info
          tls:
            - secretName: adguard-cert
              hosts:
                - adguard.tools.kilchhofer.info

        serviceTCP:
          enabled: true
          type: LoadBalancer
          externalTrafficPolicy: Local
          loadBalancerIP: "192.168.93.84"
          annotations:
            metallb.universe.tf/allow-shared-ip: adguard

        serviceUDP:
          enabled: true
          type: LoadBalancer
          externalTrafficPolicy: Local
          loadBalancerIP: "192.168.93.84"
          annotations:
            metallb.universe.tf/allow-shared-ip: adguard

        resources:
          limits:
            cpu: 500m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 64Mi

        persistence:
          config:
            enabled: false

        configAsCode:
          enabled: true
          config:
            users: []
            dns:
              port: 5353
              upstream_dns:
              - 192.168.92.1
              bootstrap_dns:
              - 192.168.92.1
            filters:
            - enabled: true
              url: https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
              name: AdGuard DNS filter
              id: 1
            - enabled: true
              url: https://adaway.org/hosts.txt
              name: AdAway
              id: 2
            - enabled: true
              url: https://www.malwaredomainlist.com/hostslist/hosts.txt
              name: MalwareDomainList.com Hosts List
              id: 4
            - enabled: true
              url: https://easylist.to/easylist/easylist.txt
              name: EasyList
              id: 10
