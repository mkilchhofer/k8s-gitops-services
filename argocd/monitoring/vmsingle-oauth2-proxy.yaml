---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  name: vm-oauth2-proxy
  namespace: argocd
spec:
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  project: apps-restricted
  syncPolicy: {}
  source:
    chart: oauth2-proxy
    repoURL: https://oauth2-proxy.github.io/manifests
    targetRevision: "5.1.0"
    helm:
      version: v3
      values: |-
        config:
          existingSecret: vm-oauth2-proxy-custom
          configFile: |-
            reverse_proxy = true
            real_client_ip_header = "X-Forwarded-For"
            provider = "oidc"
            provider_display_name = "GitHub / Dex"
            redirect_url = "https://vm.cloud.kilchhofer.info/oauth2/callback"
            oidc_issuer_url = "https://sso.cloud.kilchhofer.info"
            email_domains = [ "*" ]
            upstreams = [ "http://vmsingle-victoria-metrics-single-server.monitoring.svc:8428" ]
            silence_ping_logging = true
            cookie_secure = false
            pass_access_token = true
            pass_authorization_header = true
            allowed_groups = [
                "kilchhofer-home:admins"
            ]
            htpasswd_user_groups = [
                "kilchhofer-home:admins",
                "basic-auth"
            ]

        htpasswdFile:
          enabled: true
          existingSecret: vm-oauth2-proxy-custom-htpasswd-file
          # credentials are injected via helm-secrets

        service:
          annotations:
            prometheus.io/port: '44180'
            prometheus.io/scrape: 'true'

        ingress:
          enabled: true
          hosts:
            - vm.cloud.kilchhofer.info
          annotations:
            ingress.kubernetes.io/force-ssl-redirect: "true"
            cert-manager.io/cluster-issuer: letsencrypt
          className: nginx-external
          tls:
            - secretName: vm-oauth2-proxy-ingress-cert
              hosts:
                - vm.cloud.kilchhofer.info

        extraObjects:
          - apiVersion: networking.k8s.io/v1
            kind: NetworkPolicy
            metadata:
              name: vm-oauth2-proxy
            spec:
              podSelector:
                matchLabels:
                  app.kubernetes.io/instance: vm-oauth2-proxy
                  app.kubernetes.io/name: oauth2-proxy
              policyTypes:
                - Egress
                - Ingress
              egress:
                  # To SSO (dex)
                - ports:
                  - port: 443
                    protocol: TCP
              ingress:
                - ports:
                    - port: http
                      protocol: TCP

          - apiVersion: external-secrets.io/v1beta1
            kind: ExternalSecret
            metadata:
              name: vm-oauth2-proxy-custom
            spec:
              secretStoreRef:
                kind: ClusterSecretStore
                name: akeyless-k3s-secrets

              target:
                name: vm-oauth2-proxy-custom

              dataFrom:
              - extract:
                  key: /k3s/victoria-metrics-vmsingle/oauth2-proxy

          - apiVersion: external-secrets.io/v1beta1
            kind: ExternalSecret
            metadata:
              name: vm-oauth2-proxy-custom-htpasswd-file
            spec:
              secretStoreRef:
                kind: ClusterSecretStore
                name: akeyless-k3s-secrets

              target:
                name: vm-oauth2-proxy-custom-htpasswd-file

              data:
                - secretKey: users.txt
                  remoteRef:
                    key: /k3s/victoria-metrics-vmsingle/oauth2-proxy-htpasswd
