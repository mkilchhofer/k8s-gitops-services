---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kyverno-policies
  namespace: argocd
spec:
  destination:
    namespace: kyverno
    server: https://kubernetes.default.svc
  project: core-services-unrestricted
  syncPolicy:
    syncOptions:
      - ServerSideApply=true
  source:
    chart: kyverno-policies
    repoURL: https://kyverno.github.io/kyverno/
    targetRevision: 2.6.1
    helm:
      values: |-
        podSecurityStandard: baseline

        includeRestrictedPolicies:
        - disallow-capabilities-strict
        - disallow-privilege-escalation
        - require-run-as-non-root-user
        - require-run-as-nonroot
        - restrict-volume-types

        policyExclude:
          disallow-capabilities:
            any:
            - resources:
                namespaces:
                - kube-system
            - resources:
                kinds:
                  - Pod
                  - Deployment
                  - DaemonSet
                selector:
                  matchLabels:
                    app.kubernetes.io/instance: metallb
          disallow-host-namespaces:
            any:
            - resources:
                namespaces:
                - kube-system
            - resources:
                kinds:
                  - Pod
                  - Deployment
                  - DaemonSet
                selector:
                  matchLabels:
                    app.kubernetes.io/instance: metallb
          disallow-host-path:
            any:
            - resources:
                namespaces:
                - kube-system
          disallow-host-ports:
            any:
            - resources:
                namespaces:
                - kube-system
            - resources:
                kinds:
                  - Pod
                  - Deployment
                  - DaemonSet
                selector:
                  matchLabels:
                    app.kubernetes.io/instance: metallb
          disallow-privileged-containers:
            any:
            - resources:
                namespaces:
                - kube-system
            - resources:
                kinds:
                  - Pod
                  - DaemonSet
                selector:
                  matchLabels:
                    app.kubernetes.io/name: kured
          disallow-selinux:
            any:
            - resources:
                namespaces:
                - kube-system
          restrict-apparmor-profiles:
            any:
            - resources:
                namespaces:
                - kube-system
