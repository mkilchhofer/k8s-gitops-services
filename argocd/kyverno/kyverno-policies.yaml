---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  name: kyverno-policies
  namespace: argocd
spec:
  destination:
    namespace: kyverno
    server: https://kubernetes.default.svc
  project: core-services-unrestricted
  syncPolicy:
    syncOptions:
      - ServerSideApply=true
  source:
    chart: kyverno-policies
    repoURL: https://kyverno.github.io/kyverno/
    targetRevision: 2.7.1
    helm:
      values: |-
        autogenControllers: none
        validationFailureAction: enforce
        podSecurityStandard: baseline

        includeRestrictedPolicies:
        - disallow-capabilities-strict
        - disallow-privilege-escalation
        - require-run-as-non-root-user
        - require-run-as-nonroot
        - restrict-volume-types

        policyExclude:

          ## Excludes for baseline Policies
          ## --------------------------------
          disallow-capabilities:
            any:
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    k8s-app: cilium
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - metallb
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller

          disallow-host-namespaces:
            any:
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    k8s-app: cilium
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    name: cilium-operator
                    io.cilium/app: operator
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - metallb
                      - kured
                      - prometheus-node-exporter
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller
            - resources:
                namespaces:
                  - trivy-system
                selector:
                  matchLabels:
                    app: node-collector

          disallow-host-path:
            any:
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    k8s-app: cilium
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - promtail
                      - prometheus-node-exporter
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller
            - resources:
                namespaces:
                  - trivy-system
                selector:
                  matchLabels:
                    app: node-collector

          disallow-host-ports:
            any:
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    k8s-app: cilium
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    name: cilium-operator
                    io.cilium/app: operator
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - metallb
                      - kured
                      - prometheus-node-exporter
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller

          disallow-privileged-containers:
            any:
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    k8s-app: cilium
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - kured
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller

          disallow-selinux:
            any:
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    k8s-app: cilium

          restrict-apparmor-profiles:
            any:
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    k8s-app: cilium

          ## Excludes for restricted Policies
          ## --------------------------------
          disallow-capabilities-strict:
            any:
            - resources:
                namespaces:
                - cattle-system
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchExpressions:
                    - key: k8s-app
                      operator: In
                      values:
                      - cilium
                      - hubble-relay
                      - hubble-ui
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    name: cilium-operator
                    io.cilium/app: operator
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - metallb
                      - metrics-server
                      - plex
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller

          disallow-privilege-escalation:
            any:
            - resources:
                namespaces:
                - cattle-system
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchExpressions:
                    - key: k8s-app
                      operator: In
                      values:
                      - cilium
                      - hubble-relay
                      - hubble-ui
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    name: cilium-operator
                    io.cilium/app: operator
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - kured
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller

          require-run-as-non-root-user:
            any:
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - promtail
                      - kured
                      - metallb
                      - plex
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller
            - resources:
                namespaces:
                  - trivy-system
                selector:
                  matchLabels:
                    app.kubernetes.io/managed-by: trivy-operator
            - resources:
                namespaces:
                  - trivy-system
                selector:
                  matchLabels:
                    app: node-collector

          require-run-as-nonroot:
            any:
            - resources:
                namespaces:
                - cattle-system
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchExpressions:
                    - key: k8s-app
                      operator: In
                      values:
                      - cilium
                      - hubble-relay
                      - hubble-ui
                      - kube-dns
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    name: cilium-operator
                    io.cilium/app: operator
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - metallb
                      - promtail
                      - kured
                      - plex
            - resources:
               selector:
                  matchLabels:
                    app: nfs-data-provisioner
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller
            - resources:
                namespaces:
                  - trivy-system
                selector:
                  matchLabels:
                    app.kubernetes.io/managed-by: trivy-operator
            - resources:
                namespaces:
                  - trivy-system
                selector:
                  matchLabels:
                    app: node-collector

          restrict-volume-types:
            any:
            - resources:
                namespaces:
                - kube-system
                selector:
                  matchLabels:
                    k8s-app: cilium
            - resources:
                selector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                      - plex
                      - promtail
                      - prometheus-node-exporter
            - resources:
                selector:
                  matchLabels:
                    app: nfs-data-provisioner
            - resources:
                namespaces:
                - storage
                selector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - csi-nfs-node
                      - csi-nfs-controller
            - resources:
                namespaces:
                  - trivy-system
                selector:
                  matchLabels:
                    app: node-collector
