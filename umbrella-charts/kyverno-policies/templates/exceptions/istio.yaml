apiVersion: kyverno.io/v2
kind: PolicyException
metadata:
  name: istio
spec:
  exceptions:
  - policyName: podsecurity-restricted
    ruleNames:
    - restricted
  match:
    any:
      # Istio Sidecar injection at namespace level
      # https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#controlling-the-injection-policy
    - resources:
        kinds:
          - Pod
        namespaceSelector:
          matchLabels:
            istio-injection: enabled
      # Sidecar injection can also be controlled on a per-pod basis
    - resources:
        kinds:
          - Pod
        selector:
          matchLabels:
            sidecar.istio.io/inject: 'true'
  podSecurity:
    - controlName: Capabilities
      images:
        - "*/istio/proxyv2*"
      restrictedField: spec.initContainers[*].securityContext.capabilities.add
      values:
        - NET_ADMIN
        - NET_RAW
    - controlName: "Running as Non-root"
      images:
        - "*/istio/proxyv2*"
    - controlName: "Running as Non-root user"
      images:
        - "*/istio/proxyv2*"
    - controlName: "Seccomp"
      images:
        - "*/istio/proxyv2*"
